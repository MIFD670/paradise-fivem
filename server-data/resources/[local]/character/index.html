<style>
  body {
    font-size: 3vmin;
  }

  button {
    font-size: 1em;
    border-radius: 0.15em;
    border: 1px solid black;
  }
</style>
<script
  crossorigin
  src="https://unpkg.com/react@16/umd/react.production.min.js"
></script>
<script
  crossorigin
  src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"
></script>
<script crossorigin src="https://unpkg.com/htm@2/dist/htm.umd.js"></script>
<script crossorigin src="https://unpkg.com/immer@3/dist/immer.umd.js"></script>
<link
  href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css"
  rel="stylesheet"
/>

<script>
  const { useReducer, useEffect } = React;
  const produce = immer.default;
  const h = htm.bind(React.createElement);

  const initialState = {
    show: false
  };

  function post(url, data, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", url);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onload = function() {
      if (xhr.status === 200) {
        callback(xhr.responseText);
      }
    };
    xhr.send(data);
  }

  function postChange(field, value) {
    post("http://character/change", JSON.stringify({ field, value }));
  }

  function reducer(state, data) {
    switch (data.type) {
      case "SHOW": {
        return produce(state, draft => {
          draft.show = true;
          draft.mum = data.mum;
          draft.dad = data.dad;
          draft.mix = data.mix;
          draft.hair = data.hair;
        });
      }
      case "CHANGE": {
        return produce(state, draft => {
          draft[data.field] = data.value;
          postChange(data.field, data.value);
        });
      }
      default:
        return state;
    }
  }

  const Divv = () => {
    const [state, dispatch] = useReducer(reducer, initialState);

    useEffect(() => {
      function listener(e) {
        dispatch(e.data);
      }

      window.addEventListener("message", listener);

      return () => {
        window.removeEventListener("message", listener);
      };
    }, []);

    const { show, mum, dad, mix, hair } = state;
    if (!show) return null;

    const makeHandler = field => ev =>
      dispatch({
        type: "CHANGE",
        value: parseInt(ev.currentTarget.value),
        field
      });

    return h`<div className="bg-white inline-block rounded p-3">
        <div>Mum ID: <input type="range" min="0" max="22" value=${mum} onChange=${makeHandler(
      "mum"
    )} /></div>
        <div>Dad ID: <input type="range" min="0" max="22" value=${dad} onChange=${makeHandler(
      "dad"
    )} /></div>
        <div>Mum / Dad <input type="range" min="0" max="100" value=${mix} onChange=${makeHandler(
      "mix"
    )} /></div>
        <div>Hair: <input type="range" min="1" max="30" value=${hair} onChange=${makeHandler(
      "hair"
    )} /></div>
      </div>`;
  };

  document.addEventListener("DOMContentLoaded", () => {
    ReactDOM.render(h`<${Divv} />`, document.body);
  });
</script>
